"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>M});var i=l(861),s=l(135),n=l(408),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",C="linked-ready-maker",v="ipyflow-slice-self",h="ipyflow-slice-direct",y="ipyflow-slice",f=new Event("cleanup");class g{constructor(){this.comm=null,this.notebook=null,this.session=null,this.isIpyflowCommConnected=!1,this.executionScheduledCells=[],this.selectedCells=[],this.executedCells=new Set,this.dirtyCells=new Set,this.waitingCells=new Set,this.readyCells=new Set,this.waiterLinks={},this.readyMakerLinks={},this.prevActiveCell=null,this.activeCell=null,this.cellsById={},this.orderIdxById={},this.cellPendingExecution=null,this.isReactivelyExecuting=!1,this.numAltModeExecutes=0,this.altModeExecuteCells=null,this.lastExecutionHighlights=null,this.executedReactiveReadyCells=new Set,this.newReadyCells=new Set,this.forcedReactiveCells=new Set,this.forcedCascadingReactiveCells=new Set,this.numPendingForcedReactiveCounterBumps=0,this.cellParents={},this.cellChildren={},this.settings={},this.lastCellMetadataMap=null}gatherCellMetadataAndContent(){const e={};return this.notebook.widgets.forEach(((t,l)=>{const i=t.model;e[i.id]={index:l,content:i.sharedModel.getSource(),type:i.type}})),e}requestComputeExecSchedule(){this.comm.send({type:"compute_exec_schedule",cell_metadata_by_id:this.gatherCellMetadataAndContent(),is_reactively_executing:this.isReactivelyExecuting})}executeCells(e){if(0===e.length)return;let t=0;for(const l of e)s.CodeCell.execute(l,this.session).then((()=>{var i;(null===(i=l.promptNode.textContent)||void 0===i?void 0:i.includes("[*]"))?l.setPrompt(""):this.executedCells.add(l.model.id),++t===e.length&&this.requestComputeExecSchedule()}))}toggleReactivity(){return"reactive"===this.settings.exec_mode?this.settings.exec_mode="normal":"normal"===this.settings.exec_mode&&(this.settings.exec_mode="reactive"),this.session.session.kernel.requestExecute({code:"%flow toggle-reactivity",silent:!0,store_history:!1})}bumpForcedReactiveCounter(){return this.numPendingForcedReactiveCounterBumps--,this.session.session.kernel.requestExecute({code:"%flow bump-min-forced-reactive-counter",silent:!0,store_history:!1})}computeTransitiveClosureHelper(e,t,l,i=!1,s=!1){if(!s){if(e.has(t))return;if(i&&this.executedCells.has(t)&&!this.waitingCells.has(t)&&!this.readyCells.has(t))return}e.add(t);const n=l[t];void 0!==n&&n.forEach((t=>this.computeTransitiveClosureHelper(e,t,l,i)))}computeTransitiveClosure(e,t=!0,l=!1){const i=new Set;for(const t of e)l?this.computeTransitiveClosureHelper(i,t,this.cellParents):this.computeTransitiveClosureHelper(i,t,this.cellChildren);if(!l){for(const e of i)this.computeTransitiveClosureHelper(i,e,this.cellParents,!0,!0);if("in_order"===this.settings.flow_order){const t=Math.min(...e.map((e=>this.orderIdxById[e])));for(const e of Array.from(i)){const l=this.orderIdxById[e];(void 0===l||l<t)&&i.delete(e)}}}if(!t)for(const t of e)i.delete(t);return Array.from(i).filter((e=>void 0!==this.cellsById[e])).filter((e=>void 0!==this.orderIdxById[e])).sort(((e,t)=>this.orderIdxById[e]-this.orderIdxById[t])).map((e=>this.cellsById[e]))}}const x={};function p(e){delete x[e]}function w(e,t){const l={};for(const e in t)l[e]=t[e];for(const t in e)l[t]=e[t];return l}const _={id:"jupyterlab-ipyflow",requires:[n.INotebookTracker,i.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,i;const n=t.currentWidget.sessionContext;if(!n.isReady)return;e.commands.execute("notebook:enter-command-mode");const o=null!==(l=x[n.session.id])&&void 0!==l?l:{},c=o.altModeExecuteCells;if(o.altModeExecuteCells=null,null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return o.executedCells.add(t.activeCell.model.id),void s.CodeCell.execute(t.activeCell,n);if(("batch"===o.settings.reactivity_mode||null===c)&&"code"===t.activeCell.model.type)if(o.numAltModeExecutes++,"incremental"===o.settings.reactivity_mode)1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>{o.executedCells.add(t.activeCell.model.id),s.CodeCell.execute(t.activeCell,n)})):(o.executedCells.add(t.activeCell.model.id),s.CodeCell.execute(t.activeCell,n));else if("batch"===o.settings.reactivity_mode){let e=null!=c?c:[t.activeCell];"normal"===o.settings.exec_mode&&null===c&&(e=o.computeTransitiveClosure([t.activeCell.model.id])),1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>o.executeCells(e))):o.executeCells(e)}else console.error(`Unknown reactivity mode: ${o.settings.reactivity_mode}`)}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}});const i=l=>{var i,s;const n=t.currentWidget.sessionContext;if(!n.isReady)return;const o=null!==(i=x[n.session.id])&&void 0!==i?i:{};if(null===(s=o.isIpyflowCommConnected)||void 0===s||!s)return;e.commands.execute("notebook:enter-command-mode");const c=o.computeTransitiveClosure([o.activeCell.model.id],!0,l);o.numPendingForcedReactiveCounterBumps++,"normal"===o.settings.exec_mode?o.executeCells(c):(o.altModeExecuteCells=c,e.commands.execute("alt-mode-execute"))};e.commands.addCommand("execute-forward-slice",{label:"Execute Forward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!1)}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel J"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel ArrowDown"],selector:".jp-Notebook"}),e.commands.addCommand("execute-backward-slice",{label:"Execute Backward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!0)}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel K"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel ArrowUp"],selector:".jp-Notebook"});const o=()=>{var e,l;const i=t.currentWidget.sessionContext;if(!i.isReady)return;const s=null!==(e=x[i.session.id])&&void 0!==e?e:{};if(null!==(l=s.isIpyflowCommConnected)&&void 0!==l&&l){let e=s.executionScheduledCells;s.executionScheduledCells=[],0===e.length&&(e=[s.activeCell.model.id]);const t=s.computeTransitiveClosure(e,!1);t.length>0?s.executeCells(t):s.requestComputeExecSchedule()}};n.NotebookActions.executionScheduled.connect(((e,l)=>{var i,s,n;const o=null==t?void 0:t.currentWidget;if((null==o?void 0:o.content)!==l.notebook)return;const c=null==o?void 0:o.sessionContext;if(null===(i=null==c?void 0:c.isReady)||void 0===i||!i)return;const d=null!==(s=x[c.session.id])&&void 0!==s?s:{};if(null===(n=d.isIpyflowCommConnected)||void 0===n||!n)return;const a=d.settings,r="batch"===(null==a?void 0:a.reactivity_mode),u="reactive"===(null==a?void 0:a.exec_mode);r&&u&&"code"===l.cell.model.type&&d.executionScheduledCells.push(l.cell.model.id)})),e.commands.commandExecuted.connect(((e,l)=>{var i,s,n;const c=null==t?void 0:t.currentWidget,d=null==c?void 0:c.sessionContext;if(null===(i=null==d?void 0:d.isReady)||void 0===i||!i)return;const a=null!==(s=x[d.session.id])&&void 0!==s?s:{};if(null===(n=a.isIpyflowCommConnected)||void 0===n||!n)return;const r=a.settings,u="batch"===(null==r?void 0:r.reactivity_mode),m="reactive"===(null==r?void 0:r.exec_mode);if(u)if("notebook:run-cell"===l.id)m?o():a.requestComputeExecSchedule();else if("notebook:run-cell-and-select-next"===l.id){const e=a.activeCell;try{a.activeCell=a.prevActiveCell,m?o():a.requestComputeExecSchedule()}finally{a.activeCell=e}}})),t.widgetAdded.connect(((e,l)=>{const i=l.sessionContext;let s=()=>p(i.session.id);const n=()=>{i.session.kernel.registerCommTarget("ipyflow-client",((e,n)=>{e.onMsg=e=>{var n;const o=e.content.data;(null===(n=o.success)||void 0===n||n)&&("unestablish"===o.type?s():"establish"===o.type&&(s(),s=B(i,t,l.content)))},s(),s=B(i,t,l.content)}))};i.ready.then((()=>{S(l.content),n(),s(),s=B(i,t,l.content),i.kernelChanged.connect(((e,o)=>{null!=o.newValue&&(S(l.content),s(),p(i.session.id),s=()=>p(i.session.id),i.ready.then((()=>{n(),s=B(i,t,l.content)})))}))}))}))}},E=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},R=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},k=(e,t,l)=>{const i=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",i)};e.addEventListener(t,l),e.addEventListener("cleanup",i)},b=(e,t,l,i,s)=>{null!==e&&null!==t&&k(e,l,(()=>{t.firstElementChild.classList[i](s)}))},I=(e,t)=>{b(E(e),R(e),"mouseover","add",m),b(E(e),R(e),"mouseout","remove",m),b(R(e),E(e),"mouseover","add",t),b(R(e),E(e),"mouseout","remove",t)},S=e=>{e.widgets.forEach((e=>{e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(v),e.node.classList.remove(h),e.node.classList.remove(y);const t=E(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(C),t.dispatchEvent(f));const l=R(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(C),l.dispatchEvent(f))}))},L=(e,t,l,i,s,n,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=C;o.has(e)&&(t=m);const s=i(l[e].node);if(null===s||null===s.firstElementChild)return;s.firstElementChild.classList[n](t)}};e.addEventListener(s,c),k(e,s,c)},B=(e,t,l)=>{var i,n,o;o=e.session.id,x[o]=new g;const f=x[e.session.id];f.activeCell=l.activeCell;const _=e.session.kernel.createComm("ipyflow","ipyflow");f.comm=_,f.notebook=l,f.session=e;let k=!1;const b=e=>{null!==e&&null!==e.model&&(e.model.isDirty?f.dirtyCells.add(e.model.id):f.dirtyCells.delete(e.model.id))},B=c().debounce((()=>{if(k)return void l.model.contentChanged.disconnect(B);const e=f.gatherCellMetadataAndContent();c().isEqual(e,f.lastCellMetadataMap)||(f.lastCellMetadataMap=e,l.widgets.forEach(b),_.send({type:"notify_content_changed",cell_metadata_by_id:e}))}),500),M=(e,t)=>{k?e.stateChanged.disconnect(M):"executionCount"===t.name&&null!==t.newValue&&(f.executedCells.add(e.id),f.dirtyCells.delete(e.id),l.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),"incremental"===f.settings.reactivity_mode&&f.requestComputeExecSchedule())};for(const e of l.widgets)e.model.stateChanged.connect(M);const A=(e,t)=>{if(k)l.model.cells.changed.disconnect(A);else if("add"===t.type)for(const e of t.newValues)null==e||e.stateChanged.connect(M);else if("remove"===t.type)for(const e of t.oldValues)null==e||e.stateChanged.disconnect(M)};l.model.cells.changed.connect(A);const P=e=>{let t=-1;l.widgets.forEach(((l,i)=>{l.model.id===e.id&&(t=i)}));const i={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:t};_.send(i)},T=(e,t)=>{var i,s;l===e&&(k?l.activeCellChanged.disconnect(T):(P(t.model),f.prevActiveCell=f.activeCell,f.activeCell=t,null!==f.activeCell&&null!==f.activeCell.model&&"code"===f.activeCell.model.type&&(P(f.activeCell.model),f.dirtyCells.has(f.activeCell.model.id)&&(null===(s=(i=f.activeCell.model)._setDirty)||void 0===s||s.call(i,!0)),q(l))))},H=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],j=(e,t,l,i,s)=>{const n=f.cellsById[e].model;if("code"!==n.type)return;if(null==n.executionCount)return;const o=f.cellsById[e].node;t?o.classList.add(v):o.classList.remove(v),l&&!t?o.classList.add(h):o.classList.remove(h),!i||l||t?o.classList.remove(y):o.classList.add(y),s&&(f.waitingCells.has(e)?(o.classList.add(d),o.classList.add(a),o.classList.remove(u),I(o,m)):f.readyCells.has(e)&&(o.classList.add(u),o.classList.add(a),I(o,C)),"reactive"!==f.settings.exec_mode&&(void 0!==f.waiterLinks[e]&&H.forEach((({action:t,update:l})=>{L(E(o),f.waiterLinks[e],f.cellsById,E,t,l,f.waitingCells),L(R(o),f.waiterLinks[e],f.cellsById,E,t,l,f.waitingCells)})),void 0!==f.readyMakerLinks[e]&&(f.waitingCells.has(e)||(o.classList.add(r),o.classList.add(a)),H.forEach((({action:t,update:l})=>{L(E(o),f.readyMakerLinks[e],f.cellsById,E,t,l,f.waitingCells),L(E(o),f.readyMakerLinks[e],f.cellsById,R,t,l,f.waitingCells)})))))},q=e=>{S(e),(e=>{f.cellsById={},f.orderIdxById={},e.widgets.forEach(((e,t)=>{f.cellsById[e.model.id]=e,f.orderIdxById[e.model.id]=t}))})(e);const t=new Set;let l=new Set,i=f.selectedCells;0===i.length&&(i=[f.activeCell.model.id]);for(const e of i)void 0===f.cellChildren[e]&&void 0===f.cellParents[e]||(l=new Set([e,...l,...f.cellChildren[e],...f.cellParents[e]]),f.computeTransitiveClosureHelper(t,e,f.cellChildren),t.delete(e),f.computeTransitiveClosureHelper(t,e,f.cellParents));for(const e of t)f.computeTransitiveClosureHelper(t,e,f.cellParents,!0,!0);for(const[e]of Object.entries(f.cellsById))j(e,e===f.activeCell.model.id&&l.has(e),l.has(e),t.has(e),"none"!==f.lastExecutionHighlights)},N=()=>{var e,l,i;k&&t.selectionChanged.disconnect(N);const s=null==t?void 0:t.currentWidget,n=null==s?void 0:s.sessionContext;if(null===(e=null==n?void 0:n.isReady)||void 0===e||!e)return;const o=null!==(l=x[n.session.id])&&void 0!==l?l:{};if(null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return;const c=s.content;o.selectedCells=c.widgets.filter((e=>"code"===e.model.type&&c.isSelected(e))).map((e=>e.model.id)),q(c)};t.selectionChanged.connect(N),_.onMsg=i=>{var n,o,c,d;const a=i.content.data;if(!k&&(null===(n=a.success)||void 0===n||n))if("establish"===a.type)f.isIpyflowCommConnected=!0,l.activeCellChanged.connect(T),l.activeCell.model.stateChanged.connect(M),P(l.activeCell.model),l.model.contentChanged.connect(B),f.requestComputeExecSchedule();else if("set_exec_mode"===a.type)f.numAltModeExecutes=0,f.settings.exec_mode=a.exec_mode;else if("compute_exec_schedule"===a.type){f.settings=a.settings;const i=l.model.getMetadata("ipyflow"),n=null!==(o=null==i?void 0:i.cell_parents)&&void 0!==o?o:{},r=null!==(c=null==i?void 0:i.cell_children)&&void 0!==c?c:{};f.cellParents=w(a.cell_parents,n),f.cellChildren=w(a.cell_children,r),f.executedCells=new Set(a.executed_cells),l.model.setMetadata("ipyflow",{cell_parents:f.cellParents,cell_children:f.cellChildren}),t.currentWidget.context.save(),f.waitingCells=new Set(a.waiting_cells),f.readyCells=new Set(a.ready_cells),0===f.numPendingForcedReactiveCounterBumps?(f.forcedReactiveCells=new Set([...f.forcedReactiveCells,...a.forced_reactive_cells]),f.forcedCascadingReactiveCells=new Set([...f.forcedCascadingReactiveCells,...a.forced_cascading_reactive_cells])):(f.forcedReactiveCells=new Set,f.forcedCascadingReactiveCells=new Set),f.waiterLinks=a.waiter_links,f.readyMakerLinks=a.ready_maker_links,f.cellPendingExecution=null;const u=a.exec_mode;f.isReactivelyExecuting=f.isReactivelyExecuting||null!==(d=null==a?void 0:a.is_reactively_executing)&&void 0!==d&&d||"reactive"===u,f.newReadyCells="reactive"===u?new Set([...f.newReadyCells,...a.new_ready_cells]):new Set;const m=a.flow_order,C=a.exec_schedule;f.lastExecutionHighlights=a.highlights;const v=a.last_executed_cell_id;f.executedReactiveReadyCells.add(v);let h=!1;if(a.last_execution_was_error)h=!0;else if("batch"===f.settings.reactivity_mode){const e=f.computeTransitiveClosure(Array.from(f.forcedCascadingReactiveCells).filter((e=>!f.executedReactiveReadyCells.has(e)))).map((e=>e.model.id));let t;t="reactive"===u?f.computeTransitiveClosure([...f.newReadyCells,...f.forcedReactiveCells,...e].filter((e=>!f.executedReactiveReadyCells.has(e)))).filter((e=>!f.executedReactiveReadyCells.has(e.model.id))):[...f.forcedReactiveCells,...e].filter((e=>!f.executedReactiveReadyCells.has(e)&&void 0!==f.cellsById[e]&&void 0!==f.orderIdxById[e])).sort(((e,t)=>f.orderIdxById[e]-f.orderIdxById[t])).map((e=>f.cellsById[e])),0===t.length?h=!0:(f.isReactivelyExecuting=!0,f.executedReactiveReadyCells=new Set([...f.executedReactiveReadyCells,...t.map((e=>e.model.id))]),f.executeCells(t))}else if("incremental"===f.settings.reactivity_mode){let t=!1;for(const e of l.widgets){if(!t&&(t=e.model.id===v,"in_order"===m||"strict"===C))continue;if("code"!==e.model.type||f.executedReactiveReadyCells.has(e.model.id))continue;if(!(f.forcedReactiveCells.has(e.model.id)||f.newReadyCells.has(e.model.id)&&"reactive"===u))continue;const l=e;if(null===f.cellPendingExecution){if(f.cellPendingExecution=l,"in_order"===m||"strict"===C)break}else null==l.model.executionCount||l.model.executionCount<f.cellPendingExecution.model.executionCount&&(f.cellPendingExecution=l)}null===f.cellPendingExecution?h=!0:(f.isReactivelyExecuting=!0,f.executedCells.add(f.cellPendingExecution.model.id),s.CodeCell.execute(f.cellPendingExecution,e))}h&&(f.isReactivelyExecuting&&("reactive"===f.lastExecutionHighlights&&(f.readyCells=f.executedReactiveReadyCells),_.send({type:"reactivity_cleanup"})),f.numAltModeExecutes>0&&0==--f.numAltModeExecutes&&f.toggleReactivity(),f.numPendingForcedReactiveCounterBumps>0&&f.bumpForcedReactiveCounter(),f.forcedReactiveCells=new Set,f.forcedCascadingReactiveCells=new Set,f.newReadyCells=new Set,f.executedReactiveReadyCells=new Set,f.isReactivelyExecuting=!1,q(l))}};const F=l.model.getMetadata("ipyflow");return _.open({interface:"jupyterlab",cell_metadata_by_id:f.gatherCellMetadataAndContent(),cell_parents:null!==(i=null==F?void 0:F.cell_parents)&&void 0!==i?i:{},cell_children:null!==(n=null==F?void 0:F.cell_children)&&void 0!==n?n:{}}),()=>{_.dispose(),k=!0,f.isIpyflowCommConnected=!1,p(e.session.id)}},M=_}}]);